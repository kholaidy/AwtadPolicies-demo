
/* --- Awtad AI Widget (fixed) --- */
(function(){
  const ENDPOINT = (document.currentScript?.dataset?.endpoint)
    || window.AWTAD_AI_ENDPOINT
    || "https://awtad-policies-ai.kholaidy.workers.dev/api/policies-ai";

  // Ø²Ø± Ø¨Ø¬ÙˆØ§Ø± "Ø·Ø¨Ø§Ø¹Ø©"
  function placeButton(){
    const byText = (txt) => [...document.querySelectorAll("button, a")]
      .find(el => (el.textContent||"").trim().toLowerCase()===txt);
    let printBtn = byText("Ø·Ø¨Ø§Ø¹Ø©") || byText("print")
      || document.querySelector('[onclick*="print"],[data-action*="print"],.btn-print,.print,#print');

    let host = printBtn?.parentElement
      || document.querySelector("header,.topbar,[class*='top'],[class*='navbar']") || document.body;

    if(!document.getElementById("awtad-ai-btn")){
      const btn=document.createElement("button");
      btn.id="awtad-ai-btn";
      btn.type="button";
      btn.style.cssText="margin-inline-start:.5rem;padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;cursor:pointer";
      btn.textContent="ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª";
      btn.onclick=openModal;
      printBtn? printBtn.after(btn): host.prepend(btn);
    }
  }

  function ensureStyles(){
    if(document.getElementById("awtad-ai-style")) return;
    const css=`
    .awtad-ai-back{position:fixed;inset:0;background:#0006;z-index:9998}
    .awtad-ai{direction:rtl;position:fixed;inset:auto 50% auto auto;transform:translateX(50%);
      top:10%;width:min(720px,92vw);background:var(--c-bg,#111);color:var(--c-fg,#eee);
      border:1px solid #374151;border-radius:12px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .awtad-ai header{cursor:move;padding:.6rem .9rem;font-weight:700;border-bottom:1px solid #374151}
    .awtad-ai .body{padding:.8rem}
    .awtad-ai textarea{width:100%;min-height:140px;border:1px solid #374151;border-radius:8px;background:#0b0f14;color:#e5e7eb;padding:.6rem}
    .awtad-ai .out{margin-top:.6rem;min-height:120px;border:1px dashed #374151;border-radius:8px;padding:.6rem;white-space:pre-wrap}
    .awtad-ai footer{padding:.6rem;border-top:1px solid #374151;display:flex;gap:.5rem;justify-content:flex-start}
    .awtad-ai button{padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .awtad-ai .x{position:absolute;left:.5rem;top:.5rem;border:none;background:#374151;color:#fff;width:30px;height:30px;border-radius:6px}
    @media (prefers-color-scheme: light){
      :root{--c-bg:#fff;--c-fg:#111}
      .awtad-ai textarea{background:#fff;color:#111}
    }`;
    const s=document.createElement("style"); s.id="awtad-ai-style"; s.textContent=css; document.head.appendChild(s);
  }

  function openModal(){
    ensureStyles();
    if(document.getElementById("awtad-ai")) return;

    const back=document.createElement("div"); back.className="awtad-ai-back";
    const box=document.createElement("div"); box.className="awtad-ai"; box.id="awtad-ai";
    box.innerHTML=`
      <button class="x" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      <header>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</header>
      <div class="body">
        <textarea id="awtad-ai-text" placeholder="Ø£Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ù‡Ù†Ø§â€¦ Ø£Ùˆ Ø§ØªØ±ÙƒÙ†ÙŠ Ø£Ù‚Ø±Ø£ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"></textarea>
        <div id="awtad-ai-out" class="out"></div>
      </div>
      <footer>
        <button data-a="improve">Ø­Ø³Ù‘Ù† Ø§Ù„Ø³ÙŠØ§Ø³Ø©</button>
        <button data-a="compliance">ÙØ­Øµ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
        <button data-a="new">Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button id="awtad-ai-copy">Ù†Ø³Ø®</button>
      </footer>`;
    document.body.append(back,box);

    // Ø³Ø­Ø¨ Ø§Ù„Ù†Ø§ÙØ°Ø©
    (function drag(el,handle){
      let sx=0, sy=0, ox=0, oy=0, md=false;
      handle.addEventListener("mousedown",e=>{md=true;sx=e.clientX;sy=e.clientY;const r=el.getBoundingClientRect();ox=r.left;oy=r.top;e.preventDefault();});
      window.addEventListener("mousemove",e=>{ if(!md) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(ox+dx)+"px"; el.style.top=(oy+dy)+"px"; el.style.right="auto"; el.style.transform="none";});
      window.addEventListener("mouseup",()=>md=false);
    })(box, box.querySelector("header"));

    const ta = document.getElementById("awtad-ai-text");
    const out = document.getElementById("awtad-ai-out");
    const copyBtn = document.getElementById("awtad-ai-copy");
    const close = ()=>{ back.remove(); box.remove(); };

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„
    try{ ta.value=localStorage.getItem("awtad_ai_buffer")||""; }catch{}

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙØ¹Ø§Ù„
    box.querySelectorAll("[data-a]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const action = btn.getAttribute("data-a");
        let text = ta.value.trim();
        if(!text){
          text = (document.querySelector("main")?.innerText || document.body.innerText || "").slice(0,12000);
        }
        localStorage.setItem("awtad_ai_buffer", text);
        out.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦";
        try{
          const r = await fetch(ENDPOINT, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ text: text.slice(0,14000), page: location.pathname, action })
          });
          const j = await r.json();
          out.textContent = (j.text || "No response");
        }catch(e){
          out.textContent = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. Ø¥Ù† Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† CORS ÙˆØ§Ù„Ù€ENDPOINT.";
          console.error(e);
        }
      });
    });

    copyBtn.onclick = ()=>{
      try{ navigator.clipboard.writeText(out.textContent||""); copyBtn.textContent="Ù†ÙØ³Ø®Øª"; setTimeout(()=>copyBtn.textContent="Ù†Ø³Ø®",1200);}catch{}
    };
    box.querySelector(".x").onclick = close;
    window.addEventListener("keydown",e=>{ if(e.key==="Escape") close(); }, {once:false});
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø± + Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
  placeButton();
  const mo = new MutationObserver(()=>placeButton());
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();