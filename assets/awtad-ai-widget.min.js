
/* --- Awtad AI Widget (minimal two-action) --- */
(function(){
  const ENDPOINT = (document.currentScript?.dataset?.endpoint) || "https://<your-worker>.workers.dev/api/policies-ai";

  // Ø²Ø± Ø¨Ø¬ÙˆØ§Ø± "Ø·Ø¨Ø§Ø¹Ø©"
  function placeButton(){
    const byText = (txt) => [...document.querySelectorAll("button, a")]
      .find(el => (el.textContent||"").trim().toLowerCase()===txt);
    let printBtn = byText("Ø·Ø¨Ø§Ø¹Ø©") || byText("print")
      || document.querySelector('[onclick*="print"],[data-action*="print"],.btn-print,.print,#print');

    let host = printBtn?.parentElement
      || document.querySelector("header,.topbar,[class*='top'],[class*='navbar']") || document.body;

    if(!document.getElementById("awtad-ai-btn")){
      const btn=document.createElement("button");
      btn.id="awtad-ai-btn";
      btn.type="button";
      btn.style.cssText="margin-inline-start:.5rem;padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;cursor:pointer";
      btn.textContent="ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª";
      btn.onclick=openModal;
      printBtn? printBtn.after(btn): host.prepend(btn);
    }
  }

  function ensureStyles(){
    if(document.getElementById("awtad-ai-style")) return;
    const css=`
    .awtad-ai-back{position:fixed;inset:0;background:#0006;z-index:9998}
    .awtad-ai{direction:rtl;position:fixed;inset:auto 50% auto auto;transform:translateX(50%);
      top:10%;width:min(720px,92vw);background:var(--c-bg,#111);color:var(--c-fg,#eee);
      border:1px solid #374151;border-radius:12px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .awtad-ai header{cursor:move;padding:.6rem .9rem;font-weight:700;border-bottom:1px solid #374151}
    .awtad-ai .body{padding:.8rem}
    .awtad-ai textarea{width:100%;min-height:140px;border:1px solid #374151;border-radius:8px;background:#0b0f14;color:#e5e7eb;padding:.6rem}
    .awtad-ai .out{position:relative;margin-top:.6rem;min-height:120px;max-height:300px;border:1px dashed #374151;border-radius:8px;padding:.6rem 2.5rem .6rem .6rem;white-space:pre-wrap;overflow-y:auto;line-height:1.6}
    .awtad-ai .copy-btn{position:absolute;top:.5rem;left:.5rem;width:28px;height:28px;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;border-radius:6px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;opacity:0.7;transition:opacity 0.2s}
    .awtad-ai .copy-btn:hover{opacity:1;background:#374151}
    .awtad-ai .copy-btn.copied{background:#059669;color:#fff}
    .awtad-ai footer{padding:.6rem;border-top:1px solid #374151;display:flex;gap:.5rem;justify-content:flex-start}
    .awtad-ai button{padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .awtad-ai .x{position:absolute;left:.5rem;top:.5rem;border:none;background:#374151;color:#fff;width:30px;height:30px;border-radius:6px}
    @media (prefers-color-scheme: light){
      :root{--c-bg:#fff;--c-fg:#111}
      .awtad-ai textarea{background:#fff;color:#111}
      .awtad-ai .out{background:#f9fafb;color:#111}
      .awtad-ai .copy-btn{background:#f3f4f6;color:#111;border-color:#d1d5db}
      .awtad-ai .copy-btn:hover{background:#e5e7eb}
    }`;
    const s=document.createElement("style"); s.id="awtad-ai-style"; s.textContent=css; document.head.appendChild(s);
  }

  function openModal(){
    ensureStyles();
    if(document.getElementById("awtad-ai")) return;

    const back=document.createElement("div"); back.className="awtad-ai-back";
    const box=document.createElement("div"); box.className="awtad-ai"; box.id="awtad-ai";
    box.innerHTML=`
      <button class="x" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      <header>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</header>
      <div class="body">
        <textarea id="awtad-ai-text" placeholder="Ø£Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ù‡Ù†Ø§â€¦ Ø£Ùˆ Ø§ØªØ±ÙƒÙ†ÙŠ Ø£Ù‚Ø±Ø£ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"></textarea>
        <div id="awtad-ai-out" class="out">
          <button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>
        </div>
      </div>
      <footer>
        <button data-a="qa">Ø§Ø³Ø£Ù„ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</button>
        <button data-a="author">ÙƒØ§ØªØ¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</button>
      </footer>`;
    document.body.append(back,box);

    // Ø³Ø­Ø¨ Ø§Ù„Ù†Ø§ÙØ°Ø©
    (function drag(el,handle){
      let sx=0, sy=0, ox=0, oy=0, md=false;
      handle.addEventListener("mousedown",e=>{md=true;sx=e.clientX;sy=e.clientY;const r=el.getBoundingClientRect();ox=r.left;oy=r.top;e.preventDefault();});
      window.addEventListener("mousemove",e=>{ if(!md) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(ox+dx)+"px"; el.style.top=(oy+dy)+"px"; el.style.right="auto"; el.style.transform="none";});
      window.addEventListener("mouseup",()=>md=false);
    })(box, box.querySelector("header"));

    const ta = document.getElementById("awtad-ai-text");
    const out = document.getElementById("awtad-ai-out");
    const copyInlineBtn = document.getElementById("awtad-ai-copy-inline");
    const close = ()=>{ back.remove(); box.remove(); };

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø¥Ø¯Ø®Ø§Ù„
    try{ ta.value=localStorage.getItem("awtad_ai_buffer")||""; }catch{}

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø®
    const copyResponse = (btn) => {
      const responseText = out.textContent.replace('ğŸ“‹', '').trim();
      if(!responseText || responseText === 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦') return;
      try{ 
        navigator.clipboard.writeText(responseText); 
        const originalText = btn.textContent;
        btn.textContent = btn === copyInlineBtn ? "âœ“" : "Ù†ÙØ³Ø®Øª";
        btn.classList.add('copied');
        setTimeout(()=>{
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 1200);
      }catch{}
    };

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙØ¹Ø§Ù„
    // Ø¬Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ù…Ù† Ø¹Ù†Ø§ØµØ± data-file
    function collectPolicyUrls(){
      const base=location.origin.replace(/\/$/,'');
      const anchors=[...document.querySelectorAll('[data-file]')];
      const urls=anchors.map(a=>a.getAttribute('data-file')).filter(Boolean).map(f=>base+"/policies/"+f+".html");
      return Array.from(new Set(urls));
    }

    box.querySelectorAll("[data-a]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const action = btn.getAttribute("data-a");
        const inputText = ta.value.trim();
        let text = inputText;
        if(!text){ text = (document.querySelector("main")?.innerText || document.body.innerText || "").slice(0,12000); }
        localStorage.setItem("awtad_ai_buffer", text);

        // ØªØ­Ø°ÙŠØ± ÙˆØ§Ø¶Ø­ ÙÙŠ ÙˆØ¶Ø¹ "Ø§Ø³Ø£Ù„ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª"
        if(action==="qa"){
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button><div style="margin-bottom:.4rem;color:#b91c1c">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù‚ÙŠØ¯Ø© Ø¨Ù…Ø§ ÙˆØ±Ø¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª ÙÙ‚Ø·ØŒ ÙˆØ³ÙŠÙØ¹Ø±Ø¶ "ØºÙŠØ± Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©" Ø¹Ù†Ø¯ ØºÙŠØ§Ø¨ Ù†Øµ ØµØ±ÙŠØ­.</div>Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦`;
        } else {
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦`;
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
        const newCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
        newCopyInlineBtn.onclick = () => copyResponse(newCopyInlineBtn);
        
        try{
          const payload = { action, text: text.slice(0,8000), page: location.pathname };
          if(action==="qa"){ payload.urls = collectPolicyUrls(); payload.question = inputText; }
          const r = await fetch(ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
          const j = await r.json();
          let html = (j.result ?? j.html ?? j.text ?? "").toString();
          if(action==="author"){ if(!/class=["']policy-content["']/.test(html)){ html = `<div class="policy-content">${html}</div>`; } out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + html; }
          else { const txt = html.replace(/\n/g,'<br>'); out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + txt; }
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
          const finalCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          finalCopyInlineBtn.onclick = () => copyResponse(finalCopyInlineBtn);
        }catch(e){
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. Ø¥Ù† Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† CORS ÙˆØ§Ù„Ù€ENDPOINT.`;
          const errorCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          errorCopyInlineBtn.onclick = () => copyResponse(errorCopyInlineBtn);
          console.error(e);
        }
      });
    });

    copyInlineBtn.onclick = () => copyResponse(copyInlineBtn);
    box.querySelector(".x").onclick = close;
    window.addEventListener("keydown",e=>{ if(e.key==="Escape") close(); }, {once:false});
  }

  // ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø± + Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙ‘Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
  placeButton();
  const mo = new MutationObserver(()=>placeButton());
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();