/* --- Awtad AI Widget (minimal auto-action) --- */
(function(){
  const ENDPOINT = (document.currentScript?.dataset?.endpoint) || "https://<your-worker>.workers.dev/api/policies-ai";

  // Ø²Ø± Ø¨Ø¬ÙˆØ§Ø± "Ø·Ø¨Ø§Ø¹Ø©"
  function placeButton(){
    const byText = (txt) => [...document.querySelectorAll("button, a")]
      .find(el => (el.textContent||"").trim().toLowerCase()===txt);
    let printBtn = byText("Ø·Ø¨Ø§Ø¹Ø©") || byText("print")
      || document.querySelector('[onclick*="print\"],[data-action*="print\"],.btn-print,.print,#print');

    let host = printBtn?.parentElement
      || document.querySelector("header,.topbar,[class*='top'],[class*='navbar']") || document.body;

    if(!document.getElementById("awtad-ai-btn")){
      const btn=document.createElement("button");
      btn.id="awtad-ai-btn";
      btn.type="button";
      btn.style.cssText="margin-inline-start:.5rem;padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;cursor:pointer";
      btn.textContent="ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª";
      btn.onclick=openModal;
      printBtn? printBtn.after(btn): host.prepend(btn);
    }
  }

  function ensureStyles(){
    if(document.getElementById("awtad-ai-styles")) return;
    const s=document.createElement("style");
    s.id="awtad-ai-styles";
    s.textContent=`
      #awtad-ai-modal { position:fixed; top:4rem; right:1rem; width:min(500px, 90vw); max-width:90vw; z-index:9998; background:white; border-radius:8px; box-shadow:0 8px 24px -4px rgba(0,0,0,.3); border:1px solid #ccc; display:flex; flex-direction:column; max-height:calc(90vh - 4rem); }
      #awtad-ai-modal .h { display:flex; justify-content:space-between; align-items:center; padding:.7rem 1rem; border-bottom:1px solid #eee; background:#f9f9f9; border-radius:8px 8px 0 0; }
      #awtad-ai-modal .h .t { font-weight:bold; }
      #awtad-ai-modal .h .x { background:transparent; border:0; font-size:1.5rem; cursor:pointer; color:#777; padding:0 .5rem; line-height:1; }
      #awtad-ai-modal .b { padding:1rem; overflow-y:auto; flex-grow:1; }
      #awtad-ai-modal textarea { width:100%; border:1px solid #ccc; border-radius:4px; padding:.5rem; min-height:100px; max-height:25vh; font-family:inherit; }
      #awtad-ai-modal .out { margin-top:.7rem; border:1px solid #eee; border-radius:4px; padding:.7rem; min-height:80px; background:#fcfcfc; position:relative; max-height:40vh; overflow-y:auto; white-space:pre-wrap; line-height:1.6; }
      #awtad-ai-modal .out .policy-content { all:revert; margin: 1em 0; }
      #awtad-ai-modal .out .policy-content * { all:revert; }
      #awtad-ai-modal .out .policy-content h4 { font-weight:bold; margin-top:1em; margin-bottom:0.5em; }
      #awtad-ai-modal .out .policy-content ul { list-style-type:disc; margin-right:1.5em; }
      #awtad-ai-modal footer { padding:.7rem 1rem; border-top:1px solid #eee; background:#f9f9f9; border-radius:0 0 8px 8px; display:flex; gap:.5rem; justify-content:flex-end; }
      /* [ØªØ¹Ø¯ÙŠÙ„] ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
      #awtad-ai-modal footer button#awtad-ai-send { background:#1f2937; border:1px solid #4b5563; color:white; width:50px; height:40px; border-radius:8px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; }
      #awtad-ai-modal footer button#awtad-ai-send:hover { background:#374151; }
      #awtad-ai-modal .copy-btn { position:absolute; top:4px; left:4px; background:rgba(230,230,230,0.8); border:1px solid #ccc; border-radius:4px; cursor:pointer; opacity:0.3; transition:opacity .2s; }
      #awtad-ai-modal .out:hover .copy-btn { opacity:1; }
    `;
    document.head.appendChild(s);
  }

  //--- Awtad AI Modal ---
  function openModal(){
    if(document.getElementById("awtad-ai-modal")) return;
    ensureStyles();
    
    const box = document.createElement("div");
    box.id = "awtad-ai-modal";
    
    // [ØªØ¹Ø¯ÙŠÙ„] ØªØºÙŠÙŠØ± Ø§Ù„Ù€ footer Ù„Ø²Ø± ÙˆØ§Ø­Ø¯
    box.innerHTML = `
      <div class="h">
        <span class="t">ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</span>
        <button type="button" class="x" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button>
      </div>
      <div class="b">
        <textarea id="awtad-ai-txt" placeholder="Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ (Ù…Ø«Ù„: Ù…Ø§ Ù‡ÙŠ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§ØªØŸ) Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù…Ø«Ù„: Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø³Ù„Ø§Ù…Ø©)..." dir="auto">${localStorage.getItem("awtad_ai_buffer")||""}</textarea>
        <div id="awtad-ai-out" class="out">
          <button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>
          Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ. Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ (Ù…Ø«Ù„: Ù…Ø§ Ù‡ÙŠ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§ØªØŸ) Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù…Ø«Ù„: Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø³Ù„Ø§Ù…Ø©).
        </div>
      </div>
      <footer>
        <button id="awtad-ai-send" title="Ø¥Ø±Ø³Ø§Ù„">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </footer>`;
    
    document.body.appendChild(box);

    const ta = document.getElementById("awtad-ai-txt");
    const out = document.getElementById("awtad-ai-out");
    const copyInlineBtn = document.getElementById("awtad-ai-copy-inline");
    
    // auto-resize textarea
    ta.addEventListener("input", () => {
      ta.style.height = "auto";
      ta.style.height = (ta.scrollHeight) + "px";
    });
    setTimeout(() => { ta.style.height = "auto"; ta.style.height = (ta.scrollHeight) + "px"; }, 100);

    // --- (Helper: Collect policy URLs) ---
    function collectPolicyUrls() {
        const base = location.origin.replace(/\/$/, '');
        const anchors = Array.from(document.querySelectorAll('[data-file]'));
        const urls = anchors
            .map(a => a.getAttribute('data-file'))
            .filter(Boolean)
            .map(f => `${base}/policies/${f}.html`);
        return Array.from(new Set(urls));
    }

    // --- (Helper: Copy response) ---
    function copyResponse(btn) {
        const txt = btn.parentElement.innerText.replace(btn.innerText, "").trim();
        navigator.clipboard.writeText(txt).then(() => {
            const old=btn.innerText; btn.innerText="âœ” ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>btn.innerText=old, 1500);
        }, () => {
            const old=btn.innerText; btn.innerText="âŒ ÙØ´Ù„"; setTimeout(()=>btn.innerText=old, 1500);
        });
    }

    // [ØªØµØ­ÙŠØ­] Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù„ÙˆÙƒ "Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙØ¹Ø§Ù„" Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    // -----------------------------------------------------
    // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯
    // [ØªØµØ­ÙŠØ­] Ù†Ø³ØªØ®Ø¯Ù… box.querySelector Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† document.getElementById Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    const sendBtn = box.querySelector("#awtad-ai-send"); 
    
    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const handleSend = async () => {
        const inputText = ta.value.trim();
        if (!inputText) return; // Ù„Ø§ ØªØ±Ø³Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
        
        localStorage.setItem("awtad_ai_buffer", inputText);

        out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button> Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦`;
        const newCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
        newCopyInlineBtn.onclick = () => copyResponse(newCopyInlineBtn);
        
        try {
          // Ù†Ø±Ø³Ù„ 'auto' Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ ÙˆÙ†Ù…Ø±Ø± 'urls' Ùˆ 'text' (Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
          const payload = { 
            action: "auto", 
            text: inputText.slice(0, 8000), // Ù‡Ø°Ø§ Ù‡Ùˆ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            question: inputText.slice(0, 8000), // (Ù„Ù„ØªÙˆØ§ÙÙ‚ÙŠØ©)
            page: location.pathname,
            urls: collectPolicyUrls() // Ù†Ù…Ø±Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø¦Ù…Ø§Ù‹
          };
          
          const r = await fetch(ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
          if(!r.ok) throw new Error(`Network error ${r.status}`);
          const j = await r.json();
          if(j.error) throw new Error(j.message || j.error);
          
          let html = (j.result ?? j.html ?? j.text ?? "").toString();
          
          // Ù†ÙØ­Øµ Ø§Ù„Ù…Ø®Ø±Ø¬ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ 'detected' Ù…Ù† Ø§Ù„ÙˆÙˆØ±ÙƒØ±
          if ((j.detected === "author") || (html.startsWith("<") && !html.includes("ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±"))) {
             if(!/class=["']policy-content["']/.test(html)){ html = `<div class="policy-content">${html}</div>`; } 
             out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + html;
          } else {
             const txt = html.replace(/\n/g,'<br>'); 
             out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>` + txt;
          }
      
          // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù†Ø³Ø®
          const finalCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          finalCopyInlineBtn.onclick = () => copyResponse(finalCopyInlineBtn);
          
        } catch(e) {
          // [ØªØ­Ø³ÙŠÙ†] Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ÙØ¹Ù„ÙŠØ©
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="Ù†Ø³Ø® Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">ğŸ“‹</button>ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯. ${e.message}`;
          const errorCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          errorCopyInlineBtn.onclick = () => copyResponse(errorCopyInlineBtn);
          console.error(e);
        }
    };

    // Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„Ø²Ø±
    sendBtn.addEventListener("click", handleSend);
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter ÙÙŠ Ø§Ù„Ù€ textarea
    ta.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault(); // Ù…Ù†Ø¹ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
            handleSend(); // Ø¥Ø±Ø³Ø§Ù„
        }
    });
    // -----------------------------------------------------
    // (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ¨Ø¯Ù„)


    copyInlineBtn.onclick = () => copyResponse(copyInlineBtn);
    box.querySelector(".x").onclick = close;
    window.addEventListener("keydown",e=>{ if(e.key==="Escape") close(); });
  }

  function close(){
    const box = document.getElementById("awtad-ai-modal");
    if(box) box.remove();
  }

  if (document.readyState === "complete") placeButton();
  else window.addEventListener("load", placeButton);
})();