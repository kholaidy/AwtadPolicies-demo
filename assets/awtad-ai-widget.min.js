
/* --- Awtad AI Widget (minimal two-action) --- */
(function(){
  const ENDPOINT = (document.currentScript?.dataset?.endpoint) || "https://<your-worker>.workers.dev/api/policies-ai";

  // زر بجوار "طباعة"
  function placeButton(){
    const byText = (txt) => [...document.querySelectorAll("button, a")]
      .find(el => (el.textContent||"").trim().toLowerCase()===txt);
    let printBtn = byText("طباعة") || byText("print")
      || document.querySelector('[onclick*="print"],[data-action*="print"],.btn-print,.print,#print');

    let host = printBtn?.parentElement
      || document.querySelector("header,.topbar,[class*='top'],[class*='navbar']") || document.body;

    if(!document.getElementById("awtad-ai-btn")){
      const btn=document.createElement("button");
      btn.id="awtad-ai-btn";
      btn.type="button";
      btn.style.cssText="margin-inline-start:.5rem;padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;cursor:pointer";
      btn.textContent="🤖 مساعد السياسات";
      btn.onclick=openModal;
      printBtn? printBtn.after(btn): host.prepend(btn);
    }
  }

  function ensureStyles(){
    if(document.getElementById("awtad-ai-style")) return;
    const css=`
    .awtad-ai-back{position:fixed;inset:0;background:#0006;z-index:9998}
    .awtad-ai{direction:rtl;position:fixed;inset:auto 50% auto auto;transform:translateX(50%);
      top:10%;width:min(720px,92vw);background:var(--c-bg,#111);color:var(--c-fg,#eee);
      border:1px solid #374151;border-radius:12px;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .awtad-ai header{cursor:move;padding:.6rem .9rem;font-weight:700;border-bottom:1px solid #374151}
    .awtad-ai .body{padding:.8rem}
    .awtad-ai textarea{width:100%;min-height:140px;border:1px solid #374151;border-radius:8px;background:#0b0f14;color:#e5e7eb;padding:.6rem}
    .awtad-ai .out{position:relative;margin-top:.6rem;min-height:120px;max-height:300px;border:1px dashed #374151;border-radius:8px;padding:.6rem 2.5rem .6rem .6rem;white-space:pre-wrap;overflow-y:auto;line-height:1.6}
    .awtad-ai .copy-btn{position:absolute;top:.5rem;left:.5rem;width:28px;height:28px;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;border-radius:6px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;opacity:0.7;transition:opacity 0.2s}
    .awtad-ai .copy-btn:hover{opacity:1;background:#374151}
    .awtad-ai .copy-btn.copied{background:#059669;color:#fff}
    .awtad-ai footer{padding:.6rem;border-top:1px solid #374151;display:flex;gap:.5rem;justify-content:flex-start}
    .awtad-ai button{padding:.45rem .7rem;border-radius:.5rem;border:1px solid #4b5563;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .awtad-ai .x{position:absolute;left:.5rem;top:.5rem;border:none;background:#374151;color:#fff;width:30px;height:30px;border-radius:6px}
    @media (prefers-color-scheme: light){
      :root{--c-bg:#fff;--c-fg:#111}
      .awtad-ai textarea{background:#fff;color:#111}
      .awtad-ai .out{background:#f9fafb;color:#111}
      .awtad-ai .copy-btn{background:#f3f4f6;color:#111;border-color:#d1d5db}
      .awtad-ai .copy-btn:hover{background:#e5e7eb}
    }`;
    const s=document.createElement("style"); s.id="awtad-ai-style"; s.textContent=css; document.head.appendChild(s);
  }

  function openModal(){
    ensureStyles();
    if(document.getElementById("awtad-ai")) return;

    const back=document.createElement("div"); back.className="awtad-ai-back";
    const box=document.createElement("div"); box.className="awtad-ai"; box.id="awtad-ai";
    box.innerHTML=`
      <button class="x" title="إغلاق">×</button>
      <header>مساعد السياسات الذكي</header>
      <div class="body">
        <textarea id="awtad-ai-text" placeholder="ألصق نص السياسة هنا… أو اتركني أقرأ الصفحة الحالية"></textarea>
        <div id="awtad-ai-out" class="out">
          <button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button>
        </div>
      </div>
      <footer>
        <button data-a="qa">اسأل السياسات</button>
        <button data-a="author">كاتب السياسات</button>
      </footer>`;
    document.body.append(back,box);

    // سحب النافذة
    (function drag(el,handle){
      let sx=0, sy=0, ox=0, oy=0, md=false;
      handle.addEventListener("mousedown",e=>{md=true;sx=e.clientX;sy=e.clientY;const r=el.getBoundingClientRect();ox=r.left;oy=r.top;e.preventDefault();});
      window.addEventListener("mousemove",e=>{ if(!md) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(ox+dx)+"px"; el.style.top=(oy+dy)+"px"; el.style.right="auto"; el.style.transform="none";});
      window.addEventListener("mouseup",()=>md=false);
    })(box, box.querySelector("header"));

    const ta = document.getElementById("awtad-ai-text");
    const out = document.getElementById("awtad-ai-out");
    const copyInlineBtn = document.getElementById("awtad-ai-copy-inline");
    const close = ()=>{ back.remove(); box.remove(); };

    // استرجاع آخر إدخال
    try{ ta.value=localStorage.getItem("awtad_ai_buffer")||""; }catch{}

    // دالة النسخ
    const copyResponse = (btn) => {
      const responseText = out.textContent.replace('📋', '').trim();
      if(!responseText || responseText === 'جارٍ المعالجة…') return;
      try{ 
        navigator.clipboard.writeText(responseText); 
        const originalText = btn.textContent;
        btn.textContent = btn === copyInlineBtn ? "✓" : "نُسخت";
        btn.classList.add('copied');
        setTimeout(()=>{
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 1200);
      }catch{}
    };

    // أزرار الأفعال
    // جمع روابط السياسات من عناصر data-file
    function collectPolicyUrls(){
      const base=location.origin.replace(/\/$/,'');
      const anchors=[...document.querySelectorAll('[data-file]')];
      const urls=anchors.map(a=>a.getAttribute('data-file')).filter(Boolean).map(f=>base+"/policies/"+f+".html");
      return Array.from(new Set(urls));
    }

    box.querySelectorAll("[data-a]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const action = btn.getAttribute("data-a");
        const inputText = ta.value.trim();
        let text = inputText;
        if(!text){ text = (document.querySelector("main")?.innerText || document.body.innerText || "").slice(0,12000); }
        localStorage.setItem("awtad_ai_buffer", text);

        // تحذير واضح في وضع "اسأل السياسات"
        if(action==="qa"){
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button><div style="margin-bottom:.4rem;color:#b91c1c">تنبيه: الإجابات مقيدة بما ورد في السياسات فقط، وسيُعرض "غير مذكور في سياسات الشركة" عند غياب نص صريح.</div>جارٍ المعالجة…`;
        } else {
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button>جارٍ المعالجة…`;
        }
        
        // إعادة ربط زر النسخ الداخلي
        const newCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
        newCopyInlineBtn.onclick = () => copyResponse(newCopyInlineBtn);
        
        try{
          const payload = { action, text: text.slice(0,8000), page: location.pathname };
          if(action==="qa"){ payload.urls = collectPolicyUrls(); payload.question = inputText; }
          const r = await fetch(ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
          const j = await r.json();
          let html = (j.result ?? j.html ?? j.text ?? "").toString();
          if(action==="author"){ if(!/class=["']policy-content["']/.test(html)){ html = `<div class="policy-content">${html}</div>`; } out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button>` + html; }
          else { const txt = html.replace(/\n/g,'<br>'); out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button>` + txt; }
          
          // إعادة ربط زر النسخ الداخلي مرة أخرى
          const finalCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          finalCopyInlineBtn.onclick = () => copyResponse(finalCopyInlineBtn);
        }catch(e){
          out.innerHTML = `<button class="copy-btn" id="awtad-ai-copy-inline" title="نسخ الاستجابة">📋</button>تعذر الاتصال بالمساعد. إن استمرت المشكلة، تحقق من CORS والـENDPOINT.`;
          const errorCopyInlineBtn = document.getElementById("awtad-ai-copy-inline");
          errorCopyInlineBtn.onclick = () => copyResponse(errorCopyInlineBtn);
          console.error(e);
        }
      });
    });

    copyInlineBtn.onclick = () => copyResponse(copyInlineBtn);
    box.querySelector(".x").onclick = close;
    window.addEventListener("keydown",e=>{ if(e.key==="Escape") close(); }, {once:false});
  }

  // وضع الزر + مراقبة تغيّرات الشريط العلوي
  placeButton();
  const mo = new MutationObserver(()=>placeButton());
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();